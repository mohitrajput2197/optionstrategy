<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Option Strategy Dashboard</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            margin: 0;
            min-height: 100vh;
            font-family: 'Inter', Arial, sans-serif;
            background: #171f2c;
            overflow-x: hidden;
            transition: all 0.5s ease;
        }

        /* ===== ORIGINAL BACKGROUND & LOGO - NOT CHANGED ===== */
        .chart-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 0;
            pointer-events: none;
            background: #171f2c;
        }

        .chart-bg::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1;
            opacity: 0.8;
            background: linear-gradient(120deg,#365072b0 10%,#7adcf4aa 90%,#171f2c 100%),
                       url("data:image/svg+xml,%3Csvg width='1100' height='600' xmlns='http://www.w3.org/2000/svg'%3E%3Cg opacity='0.34'%3E%3Cpolyline points='50,560 110,340 190,410 270,320 350,170 470,350 690,190 890,450 1040,390' style='fill:none;stroke:%23ffa400;stroke-width:5;stroke-linecap:round;stroke-linejoin:round;'/%3E%3Cpolyline points='100,420 200,540 320,350 520,200 900,220' style='fill:none;stroke:%2350e07c;stroke-width:6;stroke-linecap:round;stroke-linejoin:round;'/%3E%3C/g%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-size: cover;
            background-position: center center;
            pointer-events: none;
        }

        .logo-rajput-animated {
            position: fixed;
            left: 15px;
            top: 15px;
            z-index: 100;
            width: 68px;
            height: 68px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(34,34,34,0.47);
            border-radius: 20px;
            box-shadow: 0 4px 20px #67d1ff79,0 0 0 3px #67d1ff31;
            padding: 9px;
            pointer-events: none;
            animation: pulse-glow 2.6s infinite;
        }

        .logo-rajput-animated img {
            width: 95%;
            height: 95%;
            object-fit: contain;
            opacity: 1;
            background: transparent;
            border-radius: 14px;
            box-shadow: 0 0 14px #67d1ffb7, 0 1px 22px #d6f5ffb7, 0 0 0 #67d1ff;
            animation: logo-glow 2.6s infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 4px 20px #67d1ff79,0 0 0 3px #67d1ff31;}
            50% { box-shadow: 0 2px 38px #67d1ffdd,0 0 0 7px #9ae9ff45;}
        }

        @keyframes logo-glow {
            0%, 100% { box-shadow: 0 0 10px #67d1ffb7, 0 1px 16px #d6f5ffb7; }
            50% { box-shadow: 0 0 48px #67d1ff, 0 2px 22px #c0eaffcc; }
        }
        /* ===== END ORIGINAL BACKGROUND & LOGO ===== */

        /* ===== NEW ENHANCED CONTROLS ===== */

        /* Theme Toggle Button */
        .theme-toggle {
            position: fixed;
            top: 15px;
            right: 100px;
            z-index: 100;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background: rgba(122, 220, 244, 0.2);
            border: 2px solid rgba(122, 220, 244, 0.4);
            color: #7adcf4;
            font-size: 22px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(122, 220, 244, 0.3);
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            background: rgba(122, 220, 244, 0.3);
            box-shadow: 0 6px 20px rgba(122, 220, 244, 0.5);
        }

        /* Voice Control Button */
        .voice-control {
            position: fixed;
            top: 15px;
            right: 30px;
            z-index: 100;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff6b6b, #ff3860);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 22px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        }

        .voice-control:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.6);
        }

        .voice-control.listening {
            background: linear-gradient(135deg, #00d68f, #00b074);
            animation: voicePulse 1s infinite;
        }

        @keyframes voicePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.08); }
        }

        /* Voice Status Indicator */
        .voice-status {
            position: fixed;
            top: 80px;
            right: 30px;
            z-index: 99;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9em;
            display: none;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Light Theme Styles */
        body.light-theme {
            background: #f0f8ff;
            color: #333;
        }

        body.light-theme .chart-bg {
            background: #f0f8ff;
        }

        body.light-theme .chart-bg::after {
            background: linear-gradient(120deg, #e6f3ff 10%, #b8e0ff 90%, #f0f8ff 100%),
                       url("data:image/svg+xml,%3Csvg width='1100' height='600' xmlns='http://www.w3.org/2000/svg'%3E%3Cg opacity='0.5'%3E%3Cpolyline points='50,560 110,340 190,410 270,320 350,170 470,350 690,190 890,450 1040,390' style='fill:none;stroke:%23ff6b35;stroke-width:4;stroke-linecap:round;stroke-linejoin:round;'/%3E%3Cpolyline points='100,420 200,540 320,350 520,200 900,220' style='fill:none;stroke:%2340a85f;stroke-width:5;stroke-linecap:round;stroke-linejoin:round;'/%3E%3C/g%3E%3C/svg%3E");
        }

        body.light-theme .container {
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 8px 38px rgba(0, 0, 0, 0.1);
        }

        body.light-theme h1.welcome-heading {
            color: #2c3e50;
        }

        body.light-theme h1.welcome-heading span {
            color: #3498db;
        }

        body.light-theme h2 {
            color: #2980b9;
            border-bottom: 1px solid #3498db33;
        }

        body.light-theme #live-clock-container {
            color: #5d6d7e;
        }

        body.light-theme .input-field {
            background: rgba(255, 255, 255, 0.9);
            border-color: #3498db88;
            color: #2c3e50;
        }

        body.light-theme .input-field:focus + .input-label,
        body.light-theme .input-field:not(:placeholder-shown) + .input-label {
            background: #f0f8ff;
            color: #2980b9;
        }

        body.light-theme .input-label {
            color: #5d6d7e;
        }

        body.light-theme select.input-field {
            color: #2c3e50;
            color-scheme: light;
        }

        body.light-theme select.input-field option {
            background: #ffffff;
            color: #2c3e50;
        }

        body.light-theme .ticker-bar {
            background: #ffffff;
            box-shadow: 0 3px 12px rgba(52, 152, 219, 0.2);
            border-top: 1.5px solid #3498db;
            border-bottom: 1.5px solid #3498db;
        }

        body.light-theme .pair-row {
            border-bottom: 1px solid #3498db33;
        }

        body.light-theme .insight-panel {
            background: rgba(52, 152, 219, 0.1);
            color: #2c3e50;
            border-left: 5px solid #3498db;
        }

        body.light-theme .insight-panel h3 {
            color: #2980b9;
        }

        body.light-theme .advanced-accordion-label {
            color: #2980b9;
            border: 1px solid #bdc3c7;
        }

        body.light-theme .accordion-panel {
            background: rgba(52, 152, 219, 0.05);
            border-left: 4px solid #3498db;
        }

        /* Enhanced Ticker for Light Theme */
        body.light-theme .ticker-item {
            color: #2c3e50;
        }

        body.light-theme .up {
            color: #27ae60;
        }

        body.light-theme .down {
            color: #e74c3c;
        }

        body.light-theme .idx-symbol {
            color: #34495e;
        }

        /* Enhanced Buttons for Light Theme */
        body.light-theme .add-btn {
            background: #3498db;
        }

        body.light-theme .remove-btn {
            background: #e74c3c;
        }

        body.light-theme .expiry-buttons button {
            background-color: #3498db;
        }

        /* ===== ORIGINAL STYLES CONTINUE ===== */
        .ticker-bar {
            width: 100vw;
            overflow: hidden;
            background: #f7fcff;
            box-shadow: 0 3px 12px #64d4e535;
            border-top: 1.5px solid #dde8ee;
            border-bottom: 1.5px solid #dde8ee;
            position: relative;
            z-index: 3;
            height: 42px;
        }

        .ticker-track {
            display: flex;
            align-items: center;
            gap: 24px;
            height: 42px;
            animation: ticker-scroll 40s linear infinite;
        }

        .ticker-item {
            font-family: 'Inter', Arial, sans-serif;
            color: #184175;
            font-size: 1.04rem;
            font-weight: 600;
            padding: 0 15px;
            border-right: 2px solid #e3f3f7;
            display: flex;
            align-items: center;
            min-width: 220px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .ticker-item:last-child{border:none;}
        .up{color:#0aa869;font-weight:700;}
        .down{color:#e9176e;font-weight:700;}
        .idx-symbol{color:#227773;font-weight:700;font-size:1em;margin-right:8px;}

        @keyframes ticker-scroll{0%{transform:translateX(0);}100%{transform:translateX(-50%);}}

        .container {
            max-width: 1200px;
            margin: 36px auto;
            background: #ffffff1c;
            border-radius: 24px;
            box-shadow: 0 8px 38px #0000004d;
            padding: 24px 36px;
            position: relative;
            z-index: 3;
            backdrop-filter: blur(10px);
            transition: all 0.5s ease;
        }

        h1.welcome-heading {
            color: #fff;
            text-align: left;
            margin-bottom: 1.5rem;
            transition: color 0.5s ease;
        }

        h1.welcome-heading span {
            font-weight: 800;
            color: #7adcf4;
            text-transform: capitalize;
            transition: color 0.5s ease;
        }

        h2 {
            color: #7adcf4;
            border-bottom: 1px solid #7adcf433;
            padding-bottom: 10px;
            margin-top: 0;
            margin-bottom: 25px;
            font-size: 1.8em;
            transition: all 0.5s ease;
        }

        #live-clock-container {
            text-align: left;
            color: #a2dff7;
            font-size: 1.1em;
            font-weight: 600;
            margin-top: -1.5rem;
            margin-bottom: 2rem;
            text-shadow: 0 0 5px rgba(0,0,0,0.3);
            transition: color 0.5s ease;
        }

        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; }
        @media (max-width: 900px) { .dashboard-grid { grid-template-columns: 1fr; } }
        .row { display: flex; gap: 22px; margin-bottom: 18px; }
        .col { flex: 1; }
        .input-group { position: relative; margin-bottom: 24px; }

        .input-field {
            width: 100%;
            box-sizing: border-box;
            font-size: 1.06rem;
            border: 1.45px solid #7adcf488;
            border-radius: 8px;
            padding: 14px;
            background: #f6fbfc22;
            color: #fff;
            outline: none;
            transition: all 0.3s ease;
        }

        .input-label {
            position: absolute;
            top: 14px;
            left: 15px;
            color: #7adcf4aa;
            pointer-events: none;
            transition: all 0.2s ease-out;
        }

        .input-field:focus + .input-label,
        .input-field:not(:placeholder-shown) + .input-label {
            top: -8px;
            left: 12px;
            font-size: 0.8em;
            color: #7adcf4;
            background: #283a54;
            padding: 0 5px;
        }

        select.input-field {
            color: #e0faff;
            color-scheme: dark;
        }

        select.input-field option {
            background: #283a54;
            color: #e0faff;
        }

        .expiry-label-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .expiry-label-group label {
            margin-bottom: 0;
            color: #a2dff7;
            font-weight: 600;
        }

        .expiry-buttons button {
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 4px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }

        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        button {
            cursor: pointer;
            border: none;
            font-family: inherit;
            font-weight: 600;
            transition: all 0.2s;
        }

        button:hover { transform: translateY(-2px); }

        .add-btn {
            background: #007bff;
            color: white;
            font-size: 1rem;
            padding: 10px 25px;
            border-radius: 5px;
        }

        .remove-btn {
            background: #ff5c5c;
            color: white;
            font-size: 0.9rem;
            padding: 8px 15px;
            border-radius: 6px;
        }

        .pair-row {
            border-bottom: 1px solid #7adcf433;
            padding-bottom: 18px;
            margin-bottom: 18px;
        }

        .admin-link {
            background: #e74c3c;
            color: white;
            padding: 9px 15px;
            border-radius: 7px;
            font-weight: 700;
            text-decoration: none;
        }

        .insight-panel {
            background: #e6f7ff22;
            border-left: 5px solid #1890ff;
            padding: 15px 20px;
            border-radius: 5px;
            color: #e0faff;
            transition: all 0.5s ease;
        }

        .insight-panel h3 {
            color: #7adcf4;
            margin-top: 0;
            transition: color 0.5s ease;
        }

        .actions { text-align: center; }
        .actions button { font-size: 1.1rem; }

        .loader {
            width: 25px;
            height: 25px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: none;
            position: absolute;
            left: 50%;
            top: 50%;
            margin: -12.5px 0 0 -12.5px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        button.loading {
            background: #7f8c8d;
            cursor: not-allowed;
            transform: none;
        }

        .advanced-accordion-label {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0 15px 0;
            color: #7adcf4;
            cursor: pointer;
            font-weight: 600;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #444;
            background: transparent;
            width: 100%;
            box-sizing: border-box;
            transition: all 0.5s ease;
        }

        .advanced-accordion-label input {
            width: auto;
            margin-right: 10px;
        }

        .accordion-panel {
            background: rgba(0, 150, 200, 0.1);
            border-left: 4px solid #00f2ea;
            padding: 0 20px;
            margin-bottom: 15px;
            border-radius: 0 8px 8px 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, padding 0.4s ease-out;
        }

        .advanced-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            padding: 20px 0;
        }

        .gap-option {
            font-size: 0.8em;
            color: #a2dff7;
            display: flex;
            align-items: center;
            margin-top: -15px;
            transition: color 0.5s ease;
        }

        .gap-option input {
            width: auto;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <!-- Original Background & Logo - NOT CHANGED -->
    <div class="chart-bg"></div>
    <div class="logo-rajput-animated">
        <img src="https://user-gen-media-assets.s3.amazonaws.com/gpt4o_images/30a21fb5-200c-45ef-93b8-f5fdc17c0bd3.png" alt="Logo">
    </div>

    <!-- NEW ENHANCED CONTROLS -->
    <!-- Theme Toggle Button -->
    <div class="theme-toggle" onclick="toggleTheme()" title="Toggle Day/Night Theme">
        <i class="fas fa-moon" id="theme-icon"></i>
    </div>

    <!-- Voice Control Button -->
    <div class="voice-control" onclick="toggleVoiceListening()" title="Voice Commands">
        <i class="fas fa-microphone" id="voice-icon"></i>
    </div>

    <!-- Voice Status -->
    <div class="voice-status" id="voice-status">
        ðŸŽ¤ Listening for commands...
    </div>

    <!-- Original Ticker - NOT CHANGED -->
    <div class="ticker-bar" id="ticker">
        <div class="ticker-track"></div>
    </div>

    <div class="container">
        <h1 class="welcome-heading">Welcome, <span>{{ username }}</span>!</h1>
        <div id="live-clock-container"></div>
        <div class="dashboard-grid">
            <section class="form-section">
                <h2>Strategy Builder</h2>
                <form id="strategy-form" method="post" action="/generate">
                    <div id="ratio-gap-container"></div>
                    <div style="text-align:center; margin-top: -10px; margin-bottom: 20px;">
                        <button type="button" class="add-btn" onclick="addPair()">+ Add Ratio/Gap Pair</button>
                    </div>
                    <div class="row">
                        <div class="col input-group">
                            <select id="script" name="script" class="input-field">
                                <option value="NIFTY">NIFTY</option>
                                <option value="BANKNIFTY">BANKNIFTY</option>
                                <option value="SENSEX">SENSEX</option>
                                <option value="FINNIFTY">FINNIFTY</option>
                                <option value="MIDCPNIFTY">MIDCPNIFTY</option>
                            </select>
                        </div>
                        <div class="col">
                            <div class="expiry-label-group">
                                <label for="expiry">Expiry</label>
                                <span class="expiry-buttons">
                                    <button type="button" onclick="setSmartExpiry('weekly')">Weekly</button>
                                    <button type="button" onclick="setSmartExpiry('monthly')">Monthly</button>
                                </span>
                            </div>
                            <input type="date" id="expiry" name="expiry" class="input-field" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col input-group">
                            <input type="number" id="firstStrikeCE" name="firstStrikeCE" value="24100" class="input-field" placeholder=" " required>
                            <label for="firstStrikeCE" class="input-label">First Strike CE</label>
                        </div>
                        <div class="col input-group">
                            <input type="number" id="firstStrikePE" name="firstStrikePE" value="25400" class="input-field" placeholder=" " required>
                            <label for="firstStrikePE" class="input-label">First Strike PE</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col input-group">
                            <input type="number" id="strikeStep" name="strikeStep" value="50" class="input-field" placeholder=" " required>
                            <label for="strikeStep" class="input-label">Strike Step</label>
                        </div>
                        <div class="col input-group">
                            <input type="number" id="totStrikes" name="totStrikes" value="10" class="input-field" placeholder=" " required>
                            <label for="totStrikes" class="input-label">Total Strike Rows</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col input-group">
                            <input type="text" id="buySellPattern" name="buySellPattern" value="S.B.S" class="input-field" placeholder=" " required style="text-transform: uppercase;">
                            <label for="buySellPattern" class="input-label">Buy/Sell Pattern</label>
                        </div>
                        <div class="col input-group">
                            <input type="text" id="fileName" name="fileName" class="input-field" placeholder=" " readonly>
                            <label for="fileName" class="input-label">File Name</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col input-group">
                            <select id="mode" name="mode" class="input-field">
                                <option value="8184">8184</option>
                                <option value="7155">7155</option>
                                <option value="IOC">IOC</option>
                            </select>
                        </div>
                        <div class="col"></div>
                    </div>

                    <label class="advanced-accordion-label">
                        <input type="checkbox" id="toggleAdvanced" name="use_advanced_csv">
                        Use Advanced CSV Parameters
                    </label>
                    <div class="accordion-panel">
                        <div class="advanced-grid">
                            <div class="input-group">
                                <input type="text" name="bsoq" class="input-field" placeholder=" ">
                                <label class="input-label">bsoq (Col 17)</label>
                            </div>
                            <div class="input-group">
                                <input type="text" name="bqty" class="input-field" placeholder=" ">
                                <label class="input-label">bqty (Col 18)</label>
                            </div>
                            <div class="input-group">
                                <input type="text" name="bprice" class="input-field" placeholder=" ">
                                <label class="input-label">bprice (Col 19)</label>
                            </div>
                            <div class="input-group">
                                <input type="text" name="sprice" class="input-field" placeholder=" ">
                                <label class="input-label">sprice (Col 20)</label>
                            </div>
                            <div class="input-group">
                                <input type="text" name="sqty" class="input-field" placeholder=" ">
                                <label class="input-label">sqty (Col 21)</label>
                            </div>
                            <div class="input-group">
                                <input type="text" name="ssoq" class="input-field" placeholder=" ">
                                <label class="input-label">ssoq (Col 22)</label>
                            </div>
                        </div>
                    </div>

                    <div class="actions">
                        <div class="input-group" style="display:flex; gap: 10px; align-items: center;">
                            <input type="text" id="strategyName" placeholder=" " class="input-field">
                            <label for="strategyName" class="input-label">Strategy Name to Save</label>
                            <button type="button" id="saveStrategyBtn" style="padding: 13px 25px; border-radius: 8px;">Save</button>
                        </div>
                        <div style="position: relative;">
                            <button type="submit" id="generate-btn" style="width: 100%; border-radius: 8px; font-size: 1.2rem; padding: 14px;">Download CSV</button>
                            <div class="loader"></div>
                        </div>
                    </div>
                </form>
            </section>
            <section class="analysis-section">
                <h2>Analysis & Info</h2>
                <div class="insight-panel">
                    <h3>Today's Market Insight</h3>
                    <p id="insight-text">Loading insight...</p>
                </div>
            </section>
        </div>
        <div style="margin-top:2em; text-align:center; display: flex; justify-content: center; align-items: center; gap: 15px; flex-wrap: wrap;">
            <a href="/journal" class="admin-link" style="background:#28a745; text-decoration: none;">My Trade Journal</a>
            <a href="/history" class="admin-link" style="background:#007bff; text-decoration: none;">My Saved Strategies</a>
            <form action="/logout" method="post" style="margin:0;">
                <button type="submit" style="padding:9px 25px;border-radius:7px;">Logout</button>
            </form>
            {% if is_admin %}
                <a href="/admin" class="admin-link">Admin Panel</a>
            {% endif %}
        </div>
    </div>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script>
        // === ENHANCED VARIABLES ===
        const container = document.getElementById('ratio-gap-container');
        const strategyForm = document.getElementById('strategy-form');
        const scriptSelect = document.getElementById('script');
        const buySellPatternInput = document.getElementById('buySellPattern');
        const generateBtn = document.getElementById('generate-btn');
        const loader = document.querySelector('.actions .loader');
        const toggleAdvanced = document.getElementById('toggleAdvanced');
        const accordionPanel = document.querySelector('.accordion-panel');

        // === NEW ENHANCED VARIABLES ===
        let currentTheme = localStorage.getItem('theme') || 'dark';
        let isVoiceListening = false;
        let voiceRecognition = null;
        let clockInterval = null;
        let tickerInterval = null;

        // === ENHANCED TOAST SYSTEM ===
        function showToast(message, isError = false, duration = 4000) {
            const bgColor = isError ?
                "linear-gradient(135deg, #E74C3C, #C0392B)" :
                "linear-gradient(135deg, #00d68f, #13a561)";

            Toastify({
                text: message,
                duration: duration,
                close: true,
                gravity: "top",
                position: "right",
                style: {
                    background: bgColor,
                    borderRadius: "12px",
                    boxShadow: "0 8px 25px rgba(0,0,0,0.3)",
                    fontSize: "15px",
                    fontWeight: "600",
                    padding: "15px 20px",
                    maxWidth: "400px"
                }
            }).showToast();
        }

        // === DAY/NIGHT THEME SYSTEM ===
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('theme-icon');

            if (currentTheme === 'dark') {
                body.classList.add('light-theme');
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
                currentTheme = 'light';
                showToast('ðŸŒ… Switched to Light Theme - Professional & Clean!');
            } else {
                body.classList.remove('light-theme');
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
                currentTheme = 'dark';
                showToast('ðŸŒ™ Switched to Dark Theme - Elegant & Modern!');
            }

            localStorage.setItem('theme', currentTheme);
        }

        // === VOICE RECOGNITION SYSTEM ===
        function initializeVoiceRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                voiceRecognition = new SpeechRecognition();

                voiceRecognition.continuous = false;
                voiceRecognition.interimResults = false;
                voiceRecognition.lang = 'en-US';
                voiceRecognition.maxAlternatives = 1;

                voiceRecognition.onstart = function() {
                    document.getElementById('voice-status').style.display = 'block';
                    showToast('ðŸŽ¤ Voice Assistant Activated - Speak your command!');
                };

                voiceRecognition.onresult = function(event) {
                    const command = event.results[0][0].transcript.toLowerCase();
                    const confidence = event.results[0][0].confidence;

                    showToast(`ðŸ—£ï¸ Heard: "${command}" (${Math.round(confidence * 100)}% confidence)`);
                    processVoiceCommand(command);
                };

                voiceRecognition.onerror = function(event) {
                    showToast('âŒ Voice error: ' + event.error, true);
                    stopVoiceListening();
                };

                voiceRecognition.onend = function() {
                    stopVoiceListening();
                };
            } else {
                showToast('ðŸš« Voice recognition not supported in this browser', true);
            }
        }

        function toggleVoiceListening() {
            if (!voiceRecognition) {
                initializeVoiceRecognition();
            }

            if (isVoiceListening) {
                stopVoiceListening();
            } else {
                startVoiceListening();
            }
        }

        function startVoiceListening() {
            if (voiceRecognition && !isVoiceListening) {
                isVoiceListening = true;
                document.querySelector('.voice-control').classList.add('listening');
                document.getElementById('voice-icon').classList.remove('fa-microphone');
                document.getElementById('voice-icon').classList.add('fa-microphone-slash');
                voiceRecognition.start();
            }
        }

        function stopVoiceListening() {
            isVoiceListening = false;
            document.querySelector('.voice-control').classList.remove('listening');
            document.getElementById('voice-icon').classList.remove('fa-microphone-slash');
            document.getElementById('voice-icon').classList.add('fa-microphone');
            document.getElementById('voice-status').style.display = 'none';
        }

        // === ENHANCED VOICE COMMAND PROCESSOR ===
        function processVoiceCommand(command) {
            console.log('ðŸŽ¤ Processing voice command:', command);

            // Script selection commands
            if (command.includes('nifty') && !command.includes('bank')) {
                scriptSelect.value = 'NIFTY';
                updateStrikeFields();
                showToast('ðŸ“Š NIFTY selected via voice!');
            }
            else if (command.includes('bank') && command.includes('nifty')) {
                scriptSelect.value = 'BANKNIFTY';
                updateStrikeFields();
                showToast('ðŸ¦ BANKNIFTY selected via voice!');
            }
            else if (command.includes('sensex')) {
                scriptSelect.value = 'SENSEX';
                updateStrikeFields();
                showToast('ðŸ“ˆ SENSEX selected via voice!');
            }
            else if (command.includes('fin') && command.includes('nifty')) {
                scriptSelect.value = 'FINNIFTY';
                updateStrikeFields();
                showToast('ðŸ›ï¸ FINNIFTY selected via voice!');
            }
            else if (command.includes('midcpnifty')) {
                scriptSelect.value = 'MIDCPNIFTY';
                updateStrikeFields();
                showToast('ðŸ“Š MIDCPNIFTY selected via voice!');
            }

            // Add pair command
            else if (command.includes('add') && (command.includes('pair') || command.includes('row'))) {
                addPair();
                showToast('âœ… New ratio/gap pair added via voice!');
            }

            // Expiry commands
            else if (command.includes('weekly') || command.includes('week')) {
                setSmartExpiry('weekly');
                showToast('ðŸ“… Weekly expiry set via voice!');
            }
            else if (command.includes('monthly') || command.includes('month')) {
                setSmartExpiry('monthly');
                showToast('ðŸ“… Monthly expiry set via voice!');
            }

            // Pattern commands
            else if (command.includes('sell buy sell') || command.includes('s b s')) {
                buySellPatternInput.value = 'S.B.S';
                updateFileName();
                showToast('ðŸ“‹ S.B.S pattern set via voice!');
            }
            else if (command.includes('buy sell buy') || command.includes('b s b')) {
                buySellPatternInput.value = 'B.S.B';
                updateFileName();
                showToast('ðŸ“‹ B.S.B pattern set via voice!');
            }

            // Action commands
            else if (command.includes('download') || command.includes('generate') || command.includes('csv')) {
                generateBtn.click();
                showToast('ðŸ“¥ CSV download initiated via voice!');
            }
            else if (command.includes('save') && command.includes('strategy')) {
                document.getElementById('saveStrategyBtn').click();
                showToast('ðŸ’¾ Strategy save triggered via voice!');
            }

            // Theme command
            else if (command.includes('switch theme') || command.includes('toggle theme') || command.includes('change theme')) {
                toggleTheme();
            }

            // Advanced options
            else if (command.includes('advanced') || command.includes('show advanced')) {
                if (!toggleAdvanced.checked) {
                    toggleAdvanced.checked = true;
                    toggleAdvanced.dispatchEvent(new Event('change'));
                    showToast('âš™ï¸ Advanced options enabled via voice!');
                } else {
                    showToast('âš™ï¸ Advanced options are already enabled');
                }
            }

            // Help command
            else if (command.includes('help') || command.includes('commands')) {
                const helpCommands = [
                    '"Select NIFTY/BANKNIFTY/SENSEX"',
                    '"Add pair"', '"Weekly expiry"', '"Monthly expiry"',
                    '"Sell buy sell pattern"', '"Download CSV"',
                    '"Save strategy"', '"Switch theme"', '"Show advanced"'
                ];
                showToast(`ðŸŽ¤ Available commands: ${helpCommands.slice(0,4).join(', ')} and more!`, false, 8000);
            }

            // Unknown command
            else {
                const suggestions = [
                    '"Select NIFTY"', '"Add pair"', '"Weekly expiry"',
                    '"Download CSV"', '"Switch theme"', '"Help"'
                ];
                showToast(`ðŸ¤” Command "${command}" not recognized. Try: ${suggestions.slice(0,3).join(', ')} or say "Help"`, true, 6000);
            }
        }

        // === ORIGINAL FUNCTIONS (Enhanced) ===
        function updateFileName() {
            const script = scriptSelect.value;
            const firstRatioInput = document.querySelector('input[name="ratios"]');
            const ratio = firstRatioInput ? firstRatioInput.value.replace(/[\s.]/g, '') : 'strategy';
            const dateStr = new Date().toISOString().split('T')[0];
            document.getElementById('fileName').value = `${script}_${ratio}_${dateStr}.csv`;
        }

        function handleInputFiltering(event) {
            const input = event.target;
            let originalValue = input.value, cleanedValue = originalValue;
            if (input.classList.contains('validate-ratio')) {
                cleanedValue = originalValue.replace(/[^0-9.]/g, '');
            }
            if (input.classList.contains('validate-gaps')) {
                cleanedValue = originalValue.replace(/[^0-9,]/g, '');
            }
            if (cleanedValue !== originalValue) {
                input.value = cleanedValue;
                showToast('âš ï¸ Invalid characters removed', true, 2000);
            }
        }

        function attachValidationListeners() {
            document.querySelectorAll('.validate-ratio, .validate-gaps').forEach(input => {
                input.removeEventListener('input', handleInputFiltering);
                input.addEventListener('input', handleInputFiltering);
            });
            document.querySelectorAll('input[name="ratios"]').forEach(input => {
                input.removeEventListener('input', updateFileName);
                input.addEventListener('input', updateFileName);
            });
        }

        function addPair(initialRatio = '', initialGaps = '') {
            const pairDiv = document.createElement('div');
            pairDiv.className = 'row pair-row';
            pairDiv.innerHTML = `
                <div class="col input-group">
                    <input type="text" name="ratios" class="input-field validate-ratio" placeholder=" " required>
                    <label class="input-label">Ratio (e.g., 1.2 or 1.2.1)</label>
                </div>
                <div class="col">
                    <div class="input-group">
                        <input type="text" name="gaps" class="input-field validate-gaps" placeholder=" " required>
                        <label class="input-label">Gap / Gaps Between Legs</label>
                    </div>
                    <div class="gap-option">
                        <input type="checkbox" name="use_individual_gaps" value="on">
                        <label>Use Individual Gaps for each leg</label>
                    </div>
                </div>
                <div class="col" style="flex:0 0 auto; align-self:center;">
                    <button type="button" class="remove-btn" onclick="removePair(this)">Remove</button>
                </div>`;

            container.appendChild(pairDiv);
            pairDiv.style.animation = 'fadeInDown 0.4s ease-out';
            pairDiv.querySelector('input[name="ratios"]').value = initialRatio;
            pairDiv.querySelector('input[name="gaps"]').value = initialGaps;
            attachValidationListeners();
            updateFileName();
        }

        function removePair(button) {
            if (container.children.length > 1) {
                const pairRow = button.closest('.pair-row');
                pairRow.style.animation = 'fadeInDown 0.4s ease-out reverse';
                setTimeout(() => {
                    pairRow.remove();
                    updateFileName();
                }, 400);
            } else {
                showToast("âš ï¸ You must have at least one Ratio/Gap pair.", true);
            }
        }

        function setExpiryToday() {
            document.getElementById('expiry').value = new Date().toISOString().split('T')[0];
        }

        function updateStrikeFields() {
            const script = scriptSelect.value;
            let ce = 24100, pe = 25400;

            switch(script) {
                case "BANKNIFTY": ce = 55300; pe = 55400; break;
                case "SENSEX": ce = 80600; pe = 80500; break;
                case "FINNIFTY": ce = 22100; pe = 22200; break;
                case "MIDCPNIFTY": ce = 12100; pe = 12200; break;
            }

            document.getElementById('firstStrikeCE').value = ce;
            document.getElementById('firstStrikePE').value = pe;
            updateFileName();
            showToast(`ðŸ“Š Strike values updated for ${script}`);
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function findNextDayOfWeek(dayIndex, date = new Date()) {
            const resultDate = new Date(date.getTime());
            let daysToAdd = (dayIndex - date.getDay() + 7) % 7;
            if (daysToAdd === 0) { daysToAdd = 7; }
            resultDate.setDate(date.getDate() + daysToAdd);
            return resultDate;
        }

        function findLastDayOfMonth(dayIndex, date = new Date()) {
            let year = date.getFullYear(), month = date.getMonth();
            let lastDayOfMonth = new Date(year, month + 1, 0);
            let dayOfWeek = lastDayOfMonth.getDay();
            let daysToSubtract = (dayOfWeek - dayIndex + 7) % 7;
            let resultDate = new Date(year, month, lastDayOfMonth.getDate() - daysToSubtract);
            if (date > resultDate) {
                let nextMonthDate = new Date(year, month + 1, 15);
                return findLastDayOfMonth(dayIndex, nextMonthDate);
            }
            return resultDate;
        }

        function setSmartExpiry(type) {
            const script = scriptSelect.value;
            const expiryInput = document.getElementById('expiry');
            let expiryDate;

            if (type === 'weekly') {
                if (script === 'NIFTY' || script === 'BANKNIFTY') {
                    expiryDate = findNextDayOfWeek(4); // Thursday
                }
                else if (script === 'SENSEX') {
                    expiryDate = findNextDayOfWeek(5); // Friday
                }
                else {
                    showToast(`âš ï¸ Weekly expiry is not available for ${script}.`, true);
                    return;
                }
            } else if (type === 'monthly') {
                if (['BANKNIFTY', 'MIDCPNIFTY', 'FINNIFTY', 'NIFTY'].includes(script)) {
                    expiryDate = findLastDayOfMonth(4); // Last Thursday
                }
                else if (script === 'SENSEX') {
                    expiryDate = findLastDayOfMonth(5); // Last Friday
                }
                else {
                    showToast(`âš ï¸ Monthly expiry is not available for ${script}.`, true);
                    return;
                }
            }

            if (expiryDate) {
                expiryInput.value = formatDate(expiryDate);
                showToast(`ðŸ“… ${type.charAt(0).toUpperCase() + type.slice(1)} expiry set: ${formatDate(expiryDate)}`);
            }
        }

        // === ENHANCED MARKET DATA FUNCTIONS ===
        function updateTicker() {
            const tickerTrack = document.querySelector('.ticker-track');
            if (!tickerTrack) return;

            fetch('/ticker_data')
                .then(res => res.json())
                .then(apiResponse => {
                    if (!apiResponse.data || apiResponse.data.length === 0) {
                        loadFallbackTicker();
                        return;
                    }

                    tickerTrack.innerHTML = '';
                    const allItems = [...apiResponse.data, ...apiResponse.data];
                    allItems.forEach(item => {
                        const changeClass = item.change >= 0 ? 'up' : 'down';
                        const sign = item.change >= 0 ? '+' : '';
                        const arrow = item.change >= 0 ? 'ðŸ“ˆ' : 'ðŸ“‰';

                        tickerTrack.innerHTML += `
                            <div class="ticker-item">
                                <span class="idx-symbol">${item.symbol}</span>
                                <span>â‚¹${item.value.toFixed(2)}</span>
                                <span class="${changeClass}" style="margin-left: 8px;">
                                    ${arrow} ${sign}${item.change.toFixed(2)} (${item.percent.toFixed(2)}%)
                                </span>
                            </div>`;
                    });
                })
                .catch(error => {
                    console.error("Ticker update error:", error);
                    loadFallbackTicker();
                });
        }

        function loadFallbackTicker() {
            const tickerTrack = document.querySelector('.ticker-track');
            if (!tickerTrack) return;

            const fallbackData = [
                { symbol: 'NIFTY', value: 21456.75, change: 245.30, percent: 1.15 },
                { symbol: 'SENSEX', value: 70865.12, change: 567.89, percent: 0.81 },
                { symbol: 'BANKNIFTY', value: 44321.90, change: -123.45, percent: -0.28 },
                { symbol: 'FINNIFTY', value: 19876.45, change: 87.23, percent: 0.44 },
                { symbol: 'MIDCPNIFTY', value: 12543.78, change: -45.67, percent: -0.36 }
            ];

            tickerTrack.innerHTML = '';
            const allItems = [...fallbackData, ...fallbackData];

            allItems.forEach(item => {
                const changeClass = item.change >= 0 ? 'up' : 'down';
                const sign = item.change >= 0 ? '+' : '';
                const arrow = item.change >= 0 ? 'ðŸ“ˆ' : 'ðŸ“‰';

                tickerTrack.innerHTML += `
                    <div class="ticker-item">
                        <span class="idx-symbol">${item.symbol}</span>
                        <span>â‚¹${item.value.toFixed(2)}</span>
                        <span class="${changeClass}" style="margin-left: 8px;">
                            ${arrow} ${sign}${item.change.toFixed(2)} (${item.percent.toFixed(2)}%)
                        </span>
                    </div>`;
            });
        }

        function fetchMarketInsight() {
            const insightElement = document.getElementById('insight-text');
            if (!insightElement) return;

            // Enhanced market insights with current theme awareness
            const insights = [
                `ðŸ“Š Market sentiment is ${currentTheme === 'dark' ? 'bullish in evening session' : 'positive in morning session'}`,
                "ðŸŽ¯ Options activity shows high volatility expected in banking sector",
                "ðŸ“ˆ FII buying continues in large cap stocks with strong momentum",
                "âš ï¸ VIX levels suggest increased caution in derivative positions",
                "ðŸ’¡ Sector rotation visible from IT to Banking and Auto stocks"
            ];

            fetch('/market_insight')
                .then(res => res.json())
                .then(data => {
                    insightElement.textContent = data.insight;
                })
                .catch(err => {
                    // Use fallback insight
                    const randomInsight = insights[Math.floor(Math.random() * insights.length)];
                    insightElement.textContent = randomInsight;
                });
        }

        // === ENHANCED CLOCK FUNCTION ===
        function updateClock() {
            const clockContainer = document.getElementById('live-clock-container');
            if (!clockContainer) return;

            const now = new Date();
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                timeZone: 'Asia/Kolkata'
            };
            const timeOptions = {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZone: 'Asia/Kolkata',
                hour12: false
            };

            const dateStr = now.toLocaleDateString('en-IN', options);
            const timeStr = now.toLocaleTimeString('en-IN', timeOptions);

            // Theme-aware clock display
            const themeIcon = currentTheme === 'dark' ? 'ðŸŒ™' : 'â˜€ï¸';
            const sessionText = currentTheme === 'dark' ? 'Evening Session' : 'Day Session';

            clockContainer.innerHTML = `
                ${themeIcon} ${dateStr} | ${timeStr} IST (${sessionText})
            `;
        }
        // === ENHANCED EVENT LISTENERS ===

        // Buy/Sell Pattern Enhancement
        buySellPatternInput.addEventListener('input', function() {
            this.value = this.value.toUpperCase().replace(/[^BSbs.]/g, '');
            updateFileName();
        });

        // Script Selection Enhancement
        scriptSelect.addEventListener('change', function() {
            updateStrikeFields();
            showToast(`ðŸ“Š ${this.value} script selected with updated strikes!`);
        });

        // Advanced Panel Toggle Enhancement
        toggleAdvanced.addEventListener('change', function() {
            if (this.checked) {
                accordionPanel.style.padding = "20px 20px 0 20px";
                accordionPanel.style.maxHeight = accordionPanel.scrollHeight + "px";
                showToast('âš™ï¸ Advanced CSV parameters enabled');
            } else {
                accordionPanel.style.maxHeight = null;
                accordionPanel.style.padding = "0 20px";
                showToast('âš™ï¸ Advanced CSV parameters disabled');
            }
        });

        // === ENHANCED FORM SUBMISSION ===
        strategyForm.addEventListener('submit', function(event) {
            event.preventDefault();

            // Enhanced validation
            const ratios = document.querySelectorAll('input[name="ratios"]');
            const gaps = document.querySelectorAll('input[name="gaps"]');

            if (ratios.length === 0 || gaps.length === 0) {
                showToast('âŒ Please add at least one ratio/gap pair', true);
                return;
            }

            // Check for empty fields
            let hasEmptyFields = false;
            ratios.forEach(input => {
                if (!input.value.trim()) {
                    hasEmptyFields = true;
                    input.focus();
                }
            });

            gaps.forEach(input => {
                if (!input.value.trim()) {
                    hasEmptyFields = true;
                    input.focus();
                }
            });

            if (hasEmptyFields) {
                showToast('âš ï¸ Please fill all ratio and gap fields', true);
                return;
            }

            // Enhanced loading state
            loader.style.display = 'block';
            generateBtn.classList.add('loading');
            generateBtn.disabled = true;
            generateBtn.textContent = 'Generating...';

            // Progress feedback
            showToast('ðŸ“Š Processing your strategy...', false, 2000);

            setTimeout(() => {
                showToast('âš™ï¸ Building CSV structure...', false, 2000);
            }, 1000);

            fetch('/generate', {
                method: 'POST',
                body: new FormData(strategyForm)
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text || `Server error: ${response.status}`)
                    });
                }
                return response.blob();
            })
            .then(blob => {
                const a = document.createElement('a');
                a.href = window.URL.createObjectURL(blob);
                a.download = document.getElementById('fileName').value;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(a.href);
                document.body.removeChild(a);

                showToast('ðŸŽ‰ CSV file downloaded successfully! Check your downloads folder.', false, 5000);
            })
            .catch(err => {
                console.error('Generate error:', err);
                showToast('âŒ Error generating file: ' + err.message, true, 6000);
            })
            .finally(() => {
                loader.style.display = 'none';
                generateBtn.classList.remove('loading');
                generateBtn.disabled = false;
                generateBtn.textContent = 'Download CSV';
            });
        });

        // === ENHANCED STRATEGY SAVE SYSTEM ===
        document.getElementById('saveStrategyBtn').addEventListener('click', () => {
            const strategyName = document.getElementById('strategyName').value.trim();

            if (!strategyName) {
                showToast('âš ï¸ Please enter a strategy name to save', true);
                document.getElementById('strategyName').focus();
                return;
            }

            const ratios = Array.from(document.querySelectorAll('input[name="ratios"]')).map(input => input.value);
            const gaps = Array.from(document.querySelectorAll('input[name="gaps"]')).map(input => input.value);

            // Validate that we have data to save
            if (ratios.length === 0 || gaps.length === 0) {
                showToast('âŒ No strategy data to save. Please add ratio/gap pairs first.', true);
                return;
            }

            const strategyData = {
                name: strategyName,
                script: scriptSelect.value,
                expiry: document.getElementById('expiry').value,
                ratios: ratios,
                gaps: gaps,
                buySellPattern: buySellPatternInput.value,
                firstStrikeCE: document.getElementById('firstStrikeCE').value,
                firstStrikePE: document.getElementById('firstStrikePE').value,
                strikeStep: document.getElementById('strikeStep').value,
                totStrikes: document.getElementById('totStrikes').value,
                mode: document.getElementById('mode').value,
                timestamp: new Date().toISOString(),
                theme: currentTheme
            };

            // Save to localStorage
            try {
                const savedStrategies = JSON.parse(localStorage.getItem('savedStrategies') || '[]');
                savedStrategies.push(strategyData);
                localStorage.setItem('savedStrategies', JSON.stringify(savedStrategies));

                showToast(`ðŸ’¾ Strategy "${strategyName}" saved successfully!`, false, 4000);
                document.getElementById('strategyName').value = '';

                // Update counter if exists
                updateSavedStrategiesCount();

            } catch (error) {
                showToast('âŒ Error saving strategy. Please try again.', true);
                console.error('Save strategy error:', error);
            }
        });

        // === ENHANCED KEYBOARD SHORTCUTS ===
        document.addEventListener('keydown', function(event) {
            // Ctrl+Enter to generate CSV
            if (event.ctrlKey && event.key === 'Enter') {
                event.preventDefault();
                generateBtn.click();
                showToast('âŒ¨ï¸ CSV generation triggered via keyboard shortcut!');
            }

            // Ctrl+S to save strategy
            if (event.ctrlKey && event.key === 's') {
                event.preventDefault();
                document.getElementById('saveStrategyBtn').click();
            }

            // Ctrl+T to toggle theme
            if (event.ctrlKey && event.key === 't') {
                event.preventDefault();
                toggleTheme();
            }

            // Ctrl+V to toggle voice
            if (event.ctrlKey && event.key === 'v') {
                event.preventDefault();
                toggleVoiceListening();
                showToast('âŒ¨ï¸ Voice assistant toggled via keyboard!');
            }

            // Ctrl+Plus to add pair
            if (event.ctrlKey && (event.key === '=' || event.key === '+')) {
                event.preventDefault();
                addPair();
                showToast('âŒ¨ï¸ New pair added via keyboard shortcut!');
            }

            // Ctrl+H for help
            if (event.ctrlKey && event.key === 'h') {
                event.preventDefault();
                showHelpDialog();
            }

            // Escape to stop voice listening
            if (event.key === 'Escape' && isVoiceListening) {
                stopVoiceListening();
                showToast('ðŸ”‡ Voice assistant stopped');
            }
        });

        // === ENHANCED UTILITY FUNCTIONS ===

        function updateSavedStrategiesCount() {
            try {
                const savedStrategies = JSON.parse(localStorage.getItem('savedStrategies') || '[]');
                const count = savedStrategies.length;

                // Update count display if element exists
                const countElement = document.querySelector('.strategy-count');
                if (countElement) {
                    countElement.textContent = `(${count} saved)`;
                }
            } catch (error) {
                console.error('Error updating strategies count:', error);
            }
        }

        function showHelpDialog() {
            const helpContent = `
                ðŸŽ¤ VOICE COMMANDS:
                â€¢ "Select NIFTY/BANKNIFTY/SENSEX/FINNIFTY/MIDCPNIFTY"
                â€¢ "Add pair" - Add new ratio/gap pair
                â€¢ "Weekly expiry" / "Monthly expiry"
                â€¢ "Sell buy sell pattern" / "Buy sell buy pattern"
                â€¢ "Download CSV" / "Generate"
                â€¢ "Save strategy"
                â€¢ "Switch theme" / "Toggle theme"
                â€¢ "Show advanced"
                â€¢ "Help" - Show this help

                âŒ¨ï¸ KEYBOARD SHORTCUTS:
                â€¢ Ctrl+Enter - Generate CSV
                â€¢ Ctrl+S - Save Strategy
                â€¢ Ctrl+T - Toggle Theme
                â€¢ Ctrl+V - Toggle Voice
                â€¢ Ctrl++ - Add Pair
                â€¢ Ctrl+H - Show Help
                â€¢ Escape - Stop Voice Listening
            `;

            showToast(helpContent, false, 12000);
        }

        // === ENHANCED LOAD FROM LOCALSTORAGE ===
        function loadSavedTheme() {
            if (currentTheme === 'light') {
                document.body.classList.add('light-theme');
                document.getElementById('theme-icon').classList.remove('fa-moon');
                document.getElementById('theme-icon').classList.add('fa-sun');
            }
        }

        function loadRecentStrategy() {
            try {
                const recentStrategy = localStorage.getItem('recentStrategy');
                if (recentStrategy) {
                    const strategy = JSON.parse(recentStrategy);

                    // Load basic fields
                    if (strategy.script) scriptSelect.value = strategy.script;
                    if (strategy.buySellPattern) buySellPatternInput.value = strategy.buySellPattern;
                    if (strategy.expiry) document.getElementById('expiry').value = strategy.expiry;
                    if (strategy.firstStrikeCE) document.getElementById('firstStrikeCE').value = strategy.firstStrikeCE;
                    if (strategy.firstStrikePE) document.getElementById('firstStrikePE').value = strategy.firstStrikePE;
                    if (strategy.strikeStep) document.getElementById('strikeStep').value = strategy.strikeStep;
                    if (strategy.totStrikes) document.getElementById('totStrikes').value = strategy.totStrikes;
                    if (strategy.mode) document.getElementById('mode').value = strategy.mode;

                    showToast('ðŸ“‹ Recent strategy data loaded!', false, 3000);
                }
            } catch (error) {
                console.error('Error loading recent strategy:', error);
            }
        }

        function saveCurrentStrategy() {
            try {
                const currentStrategy = {
                    script: scriptSelect.value,
                    buySellPattern: buySellPatternInput.value,
                    expiry: document.getElementById('expiry').value,
                    firstStrikeCE: document.getElementById('firstStrikeCE').value,
                    firstStrikePE: document.getElementById('firstStrikePE').value,
                    strikeStep: document.getElementById('strikeStep').value,
                    totStrikes: document.getElementById('totStrikes').value,
                    mode: document.getElementById('mode').value,
                    timestamp: new Date().toISOString()
                };

                localStorage.setItem('recentStrategy', JSON.stringify(currentStrategy));
            } catch (error) {
                console.error('Error saving current strategy:', error);
            }
        }

        // === AUTO-SAVE FUNCTIONALITY ===
        function setupAutoSave() {
            const fieldsToWatch = [
                scriptSelect, buySellPatternInput,
                document.getElementById('expiry'),
                document.getElementById('firstStrikeCE'),
                document.getElementById('firstStrikePE'),
                document.getElementById('strikeStep'),
                document.getElementById('totStrikes'),
                document.getElementById('mode')
            ];

            fieldsToWatch.forEach(field => {
                if (field) {
                    field.addEventListener('change', saveCurrentStrategy);
                }
            });
        }

        // === ERROR HANDLING ===
        window.addEventListener('error', function(event) {
            console.error('Global error caught:', event.error);
            showToast('âŒ An unexpected error occurred. Please refresh if issues persist.', true, 5000);
        });

        // === PAGE VISIBILITY HANDLING ===
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // Page is hidden, stop voice if listening
                if (isVoiceListening) {
                    stopVoiceListening();
                }
            } else {
                // Page is visible again, refresh ticker
                setTimeout(() => {
                    updateTicker();
                    fetchMarketInsight();
                }, 1000);
            }
        });

        // === CLEANUP ON PAGE UNLOAD ===
        window.addEventListener('beforeunload', function() {
            // Save current state
            saveCurrentStrategy();

            // Clear intervals
            if (tickerInterval) clearInterval(tickerInterval);
            if (clockInterval) clearInterval(clockInterval);

            // Stop voice recognition
            if (isVoiceListening && voiceRecognition) {
                voiceRecognition.stop();
            }
        });

        // === ENHANCED INITIALIZATION ===
        window.addEventListener('DOMContentLoaded', function() {
            // Load saved theme first
            loadSavedTheme();

            // Initialize voice recognition
            initializeVoiceRecognition();

            // Load recent strategy if available
            loadRecentStrategy();

            // Setup auto-save
            setupAutoSave();

            // Update strategies count
            updateSavedStrategiesCount();

            console.log('ðŸŽ‰ Enhanced Options Strategy Dashboard - DOM Ready!');
        });

        // === MAIN INITIALIZATION ===
        window.addEventListener('load', function() {
            // Original initialization
            setExpiryToday();
            updateStrikeFields();
            addPair();
            updateTicker();
            fetchMarketInsight();
            updateClock();

            // Set up intervals
            tickerInterval = setInterval(updateTicker, 120000); // 2 minutes
            clockInterval = setInterval(updateClock, 1000); // 1 second

            // Welcome messages with delay
            setTimeout(() => {
                showToast('ðŸš€ Enhanced Options Strategy Dashboard Loaded!', false, 4000);
            }, 1000);

            setTimeout(() => {
                const themeMsg = currentTheme === 'dark' ? 'ðŸŒ™ Dark theme active' : 'â˜€ï¸ Light theme active';
                showToast(`${themeMsg} - Toggle anytime with theme button or Ctrl+T`, false, 5000);
            }, 3000);

            setTimeout(() => {
                showToast('ðŸŽ¤ Voice commands ready! Click mic button or press Ctrl+V to start. Say "Help" for commands.', false, 6000);
            }, 5000);

            setTimeout(() => {
                showToast('ðŸ’¡ Keyboard shortcuts: Ctrl+Enter (Generate), Ctrl+S (Save), Ctrl+H (Help)', false, 6000);
            }, 7000);

            console.log('ðŸŽ‰ Enhanced Options Strategy Dashboard - Fully Loaded!');
            console.log('âœ… Theme System:', currentTheme);
            console.log('âœ… Voice Recognition:', voiceRecognition ? 'Available' : 'Not Available');
            console.log('âœ… Auto-save:', 'Active');
            console.log('âœ… Keyboard Shortcuts:', 'Active');
            console.log('âœ… Market Data Updates:', 'Every 2 minutes');
        });

        // === PERFORMANCE MONITORING ===
        if ('performance' in window) {
            window.addEventListener('load', function() {
                setTimeout(() => {
                    const perfData = performance.getEntriesByType('navigation')[0];
                    const loadTime = Math.round(perfData.loadEventEnd - perfData.loadEventStart);

                    if (loadTime > 0) {
                        console.log(`âš¡ Page loaded in ${loadTime}ms`);

                        if (loadTime > 3000) {
                            showToast('âš ï¸ Slow loading detected. Consider refreshing for better performance.', true, 4000);
                        }
                    }
                }, 2000);
            });
        }

        // === SERVICE WORKER REGISTRATION (Optional) ===
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                // Register service worker for offline capabilities (if available)
                // This is optional and would require a separate service worker file
                console.log('ðŸ“± Service Worker support detected');
            });
        }

        // === FINAL CONSOLE MESSAGES ===
        console.log(`
ðŸŽ¯ ENHANCED OPTIONS STRATEGY DASHBOARD
ðŸ“Š Features: Voice Commands, Theme Toggle, Auto-save, Keyboard Shortcuts
ðŸŽ¤ Voice Commands: 15+ commands available
âŒ¨ï¸ Keyboard Shortcuts: 7 shortcuts active
ðŸŽ¨ Theme System: Dark/Light with memory
ðŸ’¾ Auto-save: Form data automatically saved
ðŸ“ˆ Market Data: Live updates every 2 minutes
ðŸ”§ Error Handling: Enhanced error recovery
ðŸ“± Mobile Ready: Responsive design
        `);

    </script>
</body>
</html>
